<?php 
require_once 'Utils.php';
class Weather{
    
    private $util = '';
    
    
    function __construct(){
        $this->util = new Utils();
    }
    
    function get_url(){
        $url = 'http://api.openweathermap.org/data/2.5';
        return $url;
    }
    
    function get_key(){
        $key = '36e27a6289d33a66c84b234a81527399';
        return $key;
    }
    
    public function get_forecast($timeperiod, $lon, $lat){
        $url = $this->get_url();
        $key = $this->get_key();
        
        if($timeperiod == 'current'){
            $url = $url.'/weather?lat='.trim($lat).'&lon='.trim($lon);
        }
        
        if($timeperiod == 'fiveD'){
            $url = $url.'/forecast?lat='.$lat.'&lon='.$lon;
        }
        
//         $json = $this->curl_request($url.'&appid='.$key);
        $json = '{"coord":{"lon":0.34,"lat":32.58},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"base":"stations","main":{"temp":293.092,"pressure":1013.81,"humidity":18,"temp_min":293.092,"temp_max":293.092,"sea_level":1013.81,"grnd_level":920.15},"wind":{"speed":2.78,"deg":224.84},"clouds":{"all":0},"dt":1557901816,"sys":{"message":0.0062,"country":"DZ","sunrise":1557896432,"sunset":1557946176},"id":2498775,"name":"El Abiodh Sidi Cheikh","cod":200}';
        //$json = '{"cod":"200","message":0.0067,"cnt":40,"list":[{"dt":1557900000,"main":{"temp":297.1,"temp_min":294.192,"temp_max":297.1,"pressure":1013.96,"sea_level":1013.96,"grnd_level":885.42,"humidity":93,"temp_kf":2.91},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":1.33,"deg":216.094},"rain":{"3h":0.375},"sys":{"pod":"d"},"dt_txt":"2019-05-15 06:00:00"},{"dt":1557910800,"main":{"temp":301.18,"temp_min":298.995,"temp_max":301.18,"pressure":1012.73,"sea_level":1012.73,"grnd_level":884.85,"humidity":67,"temp_kf":2.18},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":2.01,"deg":166.871},"rain":{"3h":2.5},"sys":{"pod":"d"},"dt_txt":"2019-05-15 09:00:00"},{"dt":1557921600,"main":{"temp":298.95,"temp_min":297.5,"temp_max":298.95,"pressure":1010.01,"sea_level":1010.01,"grnd_level":882.55,"humidity":90,"temp_kf":1.45},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":2.4,"deg":189.588},"rain":{"3h":3.312},"sys":{"pod":"d"},"dt_txt":"2019-05-15 12:00:00"},{"dt":1557932400,"main":{"temp":296.63,"temp_min":295.9,"temp_max":296.63,"pressure":1010.06,"sea_level":1010.06,"grnd_level":882.55,"humidity":90,"temp_kf":0.73},"weather":[{"id":501,"main":"Rain","description":"moderate rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":1.27,"deg":239.013},"rain":{"3h":3.312},"sys":{"pod":"d"},"dt_txt":"2019-05-15 15:00:00"},{"dt":1557943200,"main":{"temp":292.339,"temp_min":292.339,"temp_max":292.339,"pressure":1011.3,"sea_level":1011.3,"grnd_level":883.38,"humidity":96,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":100},"wind":{"speed":1.24,"deg":190.437},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-05-15 18:00:00"},{"dt":1557954000,"main":{"temp":292.2,"temp_min":292.2,"temp_max":292.2,"pressure":1011.85,"sea_level":1011.85,"grnd_level":883.82,"humidity":96,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":100},"wind":{"speed":1.07,"deg":212.652},"sys":{"pod":"n"},"dt_txt":"2019-05-15 21:00:00"},{"dt":1557964800,"main":{"temp":291.525,"temp_min":291.525,"temp_max":291.525,"pressure":1011.31,"sea_level":1011.31,"grnd_level":883.24,"humidity":97,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":100},"wind":{"speed":1.1,"deg":236.803},"sys":{"pod":"n"},"dt_txt":"2019-05-16 00:00:00"},{"dt":1557975600,"main":{"temp":290.9,"temp_min":290.9,"temp_max":290.9,"pressure":1012.07,"sea_level":1012.07,"grnd_level":883.92,"humidity":98,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":97},"wind":{"speed":1.01,"deg":245.458},"sys":{"pod":"n"},"dt_txt":"2019-05-16 03:00:00"},{"dt":1557986400,"main":{"temp":296.024,"temp_min":296.024,"temp_max":296.024,"pressure":1013.86,"sea_level":1013.86,"grnd_level":885.66,"humidity":78,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04d"}],"clouds":{"all":98},"wind":{"speed":0.97,"deg":203.586},"sys":{"pod":"d"},"dt_txt":"2019-05-16 06:00:00"},{"dt":1557997200,"main":{"temp":298,"temp_min":298,"temp_max":298,"pressure":1012.9,"sea_level":1012.9,"grnd_level":885.26,"humidity":88,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":100},"wind":{"speed":1.86,"deg":153.504},"rain":{"3h":2.875},"sys":{"pod":"d"},"dt_txt":"2019-05-16 09:00:00"},{"dt":1558008000,"main":{"temp":299.8,"temp_min":299.8,"temp_max":299.8,"pressure":1009.88,"sea_level":1009.88,"grnd_level":882.68,"humidity":68,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":84},"wind":{"speed":1.95,"deg":202.994},"rain":{"3h":2.687},"sys":{"pod":"d"},"dt_txt":"2019-05-16 12:00:00"},{"dt":1558018800,"main":{"temp":297.555,"temp_min":297.555,"temp_max":297.555,"pressure":1009.05,"sea_level":1009.05,"grnd_level":881.94,"humidity":73,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":78},"wind":{"speed":1.86,"deg":212.471},"rain":{"3h":0.312},"sys":{"pod":"d"},"dt_txt":"2019-05-16 15:00:00"},{"dt":1558029600,"main":{"temp":293.3,"temp_min":293.3,"temp_max":293.3,"pressure":1011.7,"sea_level":1011.7,"grnd_level":883.83,"humidity":86,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":89},"wind":{"speed":1.6,"deg":204.675},"rain":{"3h":0.063},"sys":{"pod":"n"},"dt_txt":"2019-05-16 18:00:00"},{"dt":1558040400,"main":{"temp":292,"temp_min":292,"temp_max":292,"pressure":1012.65,"sea_level":1012.65,"grnd_level":884.55,"humidity":92,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":92},"wind":{"speed":1.06,"deg":211.419},"sys":{"pod":"n"},"dt_txt":"2019-05-16 21:00:00"},{"dt":1558051200,"main":{"temp":291.6,"temp_min":291.6,"temp_max":291.6,"pressure":1011.27,"sea_level":1011.27,"grnd_level":883.13,"humidity":93,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":96},"wind":{"speed":1.16,"deg":223.252},"sys":{"pod":"n"},"dt_txt":"2019-05-17 00:00:00"},{"dt":1558062000,"main":{"temp":290.583,"temp_min":290.583,"temp_max":290.583,"pressure":1011.1,"sea_level":1011.1,"grnd_level":883,"humidity":97,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":82},"wind":{"speed":1.07,"deg":222.616},"sys":{"pod":"n"},"dt_txt":"2019-05-17 03:00:00"},{"dt":1558072800,"main":{"temp":297,"temp_min":297,"temp_max":297,"pressure":1013.31,"sea_level":1013.31,"grnd_level":885.13,"humidity":69,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":82},"wind":{"speed":1.17,"deg":211.521},"sys":{"pod":"d"},"dt_txt":"2019-05-17 06:00:00"},{"dt":1558083600,"main":{"temp":299.7,"temp_min":299.7,"temp_max":299.7,"pressure":1012.94,"sea_level":1012.94,"grnd_level":885.45,"humidity":61,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":71},"wind":{"speed":2.32,"deg":185.248},"rain":{"3h":2.25},"sys":{"pod":"d"},"dt_txt":"2019-05-17 09:00:00"},{"dt":1558094400,"main":{"temp":302.7,"temp_min":302.7,"temp_max":302.7,"pressure":1009.7,"sea_level":1009.7,"grnd_level":882.14,"humidity":45,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":57},"wind":{"speed":2.53,"deg":179.569},"rain":{"3h":0.062},"sys":{"pod":"d"},"dt_txt":"2019-05-17 12:00:00"},{"dt":1558105200,"main":{"temp":299.107,"temp_min":299.107,"temp_max":299.107,"pressure":1008.98,"sea_level":1008.98,"grnd_level":881.83,"humidity":59,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":43},"wind":{"speed":2.58,"deg":185.379},"sys":{"pod":"d"},"dt_txt":"2019-05-17 15:00:00"},{"dt":1558116000,"main":{"temp":292.3,"temp_min":292.3,"temp_max":292.3,"pressure":1011.72,"sea_level":1011.72,"grnd_level":883.87,"humidity":93,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":41},"wind":{"speed":1.67,"deg":196.66},"rain":{"3h":0.938},"sys":{"pod":"n"},"dt_txt":"2019-05-17 18:00:00"},{"dt":1558126800,"main":{"temp":291.428,"temp_min":291.428,"temp_max":291.428,"pressure":1012.03,"sea_level":1012.03,"grnd_level":883.88,"humidity":96,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":34},"wind":{"speed":0.97,"deg":210.57},"rain":{"3h":0.562},"sys":{"pod":"n"},"dt_txt":"2019-05-17 21:00:00"},{"dt":1558137600,"main":{"temp":291.015,"temp_min":291.015,"temp_max":291.015,"pressure":1010.55,"sea_level":1010.55,"grnd_level":882.39,"humidity":97,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":43},"wind":{"speed":1.23,"deg":231.304},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-05-18 00:00:00"},{"dt":1558148400,"main":{"temp":290.298,"temp_min":290.298,"temp_max":290.298,"pressure":1011.04,"sea_level":1011.04,"grnd_level":882.77,"humidity":98,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":40},"wind":{"speed":1.2,"deg":223.823},"sys":{"pod":"n"},"dt_txt":"2019-05-18 03:00:00"},{"dt":1558159200,"main":{"temp":295.862,"temp_min":295.862,"temp_max":295.862,"pressure":1013.09,"sea_level":1013.09,"grnd_level":884.96,"humidity":77,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":49},"wind":{"speed":1.14,"deg":212.262},"sys":{"pod":"d"},"dt_txt":"2019-05-18 06:00:00"},{"dt":1558170000,"main":{"temp":299.8,"temp_min":299.8,"temp_max":299.8,"pressure":1012.22,"sea_level":1012.22,"grnd_level":884.62,"humidity":64,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":44},"wind":{"speed":2.46,"deg":173.04},"sys":{"pod":"d"},"dt_txt":"2019-05-18 09:00:00"},{"dt":1558180800,"main":{"temp":299.902,"temp_min":299.902,"temp_max":299.902,"pressure":1008.81,"sea_level":1008.81,"grnd_level":881.61,"humidity":67,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":40},"wind":{"speed":2.16,"deg":189.996},"rain":{"3h":2.624},"sys":{"pod":"d"},"dt_txt":"2019-05-18 12:00:00"},{"dt":1558191600,"main":{"temp":299.185,"temp_min":299.185,"temp_max":299.185,"pressure":1008.42,"sea_level":1008.42,"grnd_level":881.42,"humidity":57,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":38},"wind":{"speed":2.12,"deg":186.382},"rain":{"3h":0.062},"sys":{"pod":"d"},"dt_txt":"2019-05-18 15:00:00"},{"dt":1558202400,"main":{"temp":293.177,"temp_min":293.177,"temp_max":293.177,"pressure":1011.29,"sea_level":1011.29,"grnd_level":883.52,"humidity":82,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":47},"wind":{"speed":1.69,"deg":204.576},"rain":{},"sys":{"pod":"n"},"dt_txt":"2019-05-18 18:00:00"},{"dt":1558213200,"main":{"temp":291.613,"temp_min":291.613,"temp_max":291.613,"pressure":1012.14,"sea_level":1012.14,"grnd_level":883.93,"humidity":90,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":49},"wind":{"speed":1.23,"deg":215.218},"sys":{"pod":"n"},"dt_txt":"2019-05-18 21:00:00"},{"dt":1558224000,"main":{"temp":290.8,"temp_min":290.8,"temp_max":290.8,"pressure":1010.61,"sea_level":1010.61,"grnd_level":882.35,"humidity":95,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":56},"wind":{"speed":1.15,"deg":242.365},"sys":{"pod":"n"},"dt_txt":"2019-05-19 00:00:00"},{"dt":1558234800,"main":{"temp":289.9,"temp_min":289.9,"temp_max":289.9,"pressure":1011.62,"sea_level":1011.62,"grnd_level":883.14,"humidity":98,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":52},"wind":{"speed":1.17,"deg":243.062},"sys":{"pod":"n"},"dt_txt":"2019-05-19 03:00:00"},{"dt":1558245600,"main":{"temp":296.5,"temp_min":296.5,"temp_max":296.5,"pressure":1013.95,"sea_level":1013.95,"grnd_level":885.61,"humidity":67,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":51},"wind":{"speed":1.09,"deg":235.695},"sys":{"pod":"d"},"dt_txt":"2019-05-19 06:00:00"},{"dt":1558256400,"main":{"temp":301.5,"temp_min":301.5,"temp_max":301.5,"pressure":1012.22,"sea_level":1012.22,"grnd_level":884.17,"humidity":48,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":50},"wind":{"speed":2.32,"deg":161.307},"sys":{"pod":"d"},"dt_txt":"2019-05-19 09:00:00"},{"dt":1558267200,"main":{"temp":299.9,"temp_min":299.9,"temp_max":299.9,"pressure":1008.93,"sea_level":1008.93,"grnd_level":881.62,"humidity":64,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":50},"wind":{"speed":2.17,"deg":180.74},"rain":{"3h":1.75},"sys":{"pod":"d"},"dt_txt":"2019-05-19 12:00:00"},{"dt":1558278000,"main":{"temp":295.5,"temp_min":295.5,"temp_max":295.5,"pressure":1009.23,"sea_level":1009.23,"grnd_level":882.11,"humidity":92,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":35},"wind":{"speed":0.98,"deg":145.518},"rain":{"3h":2.562},"sys":{"pod":"d"},"dt_txt":"2019-05-19 15:00:00"},{"dt":1558288800,"main":{"temp":291.8,"temp_min":291.8,"temp_max":291.8,"pressure":1012.64,"sea_level":1012.64,"grnd_level":884.5,"humidity":95,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":56},"wind":{"speed":0.7,"deg":226.157},"rain":{"3h":0.063},"sys":{"pod":"n"},"dt_txt":"2019-05-19 18:00:00"},{"dt":1558299600,"main":{"temp":291,"temp_min":291,"temp_max":291,"pressure":1013.08,"sea_level":1013.08,"grnd_level":884.84,"humidity":97,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":93},"wind":{"speed":0.71,"deg":217.08},"rain":{"3h":0.438},"sys":{"pod":"n"},"dt_txt":"2019-05-19 21:00:00"},{"dt":1558310400,"main":{"temp":290.3,"temp_min":290.3,"temp_max":290.3,"pressure":1011.53,"sea_level":1011.53,"grnd_level":883.2,"humidity":97,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":95},"wind":{"speed":1.11,"deg":244.887},"rain":{"3h":0.5},"sys":{"pod":"n"},"dt_txt":"2019-05-20 00:00:00"},{"dt":1558321200,"main":{"temp":289.8,"temp_min":289.8,"temp_max":289.8,"pressure":1012.64,"sea_level":1012.64,"grnd_level":884.12,"humidity":98,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":100},"wind":{"speed":1.03,"deg":247.342},"sys":{"pod":"n"},"dt_txt":"2019-05-20 03:00:00"}],"city":{"id":443339,"name":"Kampala District","coord":{"lat":0.3351,"lon":32.5831},"country":"UG"}}';
        return $this->process_response($json);
    }
    
    function process_response($response){
        $json = json_decode($response, true);
        
        $w = $json['weather'][0];
        $m = $json['main'];
        $weather = array(
            "main"=>$w['main'],
            "description"=>$w['description'],
            "icon"=>$w['icon'],
            "temp"=> $m['temp'],
            "humidity"=> $m['humidity'] 
        );
        return $weather;
    }
    
    function curl_request($url){
        $this->util->m_log($url);
        //Initialize cURL.
        $ch = curl_init();
        
        //Set the URL that you want to GET by using the CURLOPT_URL option.
        curl_setopt($ch, CURLOPT_URL, $url);
        
        //Set CURLOPT_RETURNTRANSFER so that the content is returned as a variable.
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        
        //Set CURLOPT_FOLLOWLOCATION to true to follow redirects.
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
        
        //Execute the request.
        $data = curl_exec($ch);
        
        //Close the cURL handle.
        curl_close($ch);
        
        //Print the data out onto the page.
        return $data;
    }
}
?>